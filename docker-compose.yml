# ============================================================================
#  Copyright 2024 Northern Pacific Technologies, LLC
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#  
#     http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
# ============================================================================

# For development and/or evaluation purposes only

services:

  mysql-server-1:
    image: mysql/mysql-server
    container_name: mysql-server-1
    environment: 
      MYSQL_ROOT_PASSWORD: 'password'
      MYSQL_ROOT_HOST: '%'
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      timeout: 20s
      retries: 10
    ports:
      - "3301:3306"
    # Comment the following two lines for ephemeral mode. The data
    # will henceforth reside only in the container for its lifetime.
    # Once the container is deleted, the data will also be deleted.
    # See README.md for persistant data recover is a container is 
    # lost/deleted.
    volumes: 
      - ./data/server-1:/var/lib/mysql      
    restart: always
    command: [
      "mysqld",
      "--server_id=1",
      "--mysqlx=ON",
      "--binlog_checksum=NONE",
      "--gtid_mode=ON",
      "--enforce_gtid_consistency=ON",
      "--log_bin",
      "--log_slave_updates=ON",
      "--master_info_repository=TABLE",
      "--relay_log_info_repository=TABLE",
      "--transaction_write_set_extraction=XXHASH64",
      "--user=root",
      "--skip-host-cache",
      "--skip-name-resolve", 
      "--default_authentication_plugin=mysql_native_password",
      "--binlog_transaction_dependency_tracking=WRITESET"]

  mysql-server-2:
    image: mysql/mysql-server
    container_name: mysql-server-2
    environment: 
      MYSQL_ROOT_PASSWORD: 'password'
      MYSQL_ROOT_HOST: '%'
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      timeout: 20s
      retries: 10
    ports:
      - "3302:3306"
    # Comment the following two lines for ephemeral mode. The data
    # will henceforth reside only in the container for its lifetime.
    # Once the container is deleted, the data will also be deleted.
    # See README.md for persistant data recover is a container is 
    # lost/deleted.
    volumes: 
      - ./data/server-2:/var/lib/mysql      
    restart: always
    command: [
      "mysqld",
      "--server_id=2",
      "--mysqlx=ON",
      "--binlog_checksum=NONE",
      "--gtid_mode=ON",
      "--enforce_gtid_consistency=ON",
      "--log_bin",
      "--log_slave_updates=ON",
      "--master_info_repository=TABLE",
      "--relay_log_info_repository=TABLE",
      "--transaction_write_set_extraction=XXHASH64",
      "--user=root",
      "--skip-host-cache",
      "--skip-name-resolve", 
      "--default_authentication_plugin=mysql_native_password",
      "--binlog_transaction_dependency_tracking=WRITESET"]

  mysql-server-3:
    image: mysql/mysql-server
    container_name: mysql-server-3
    user: root
    environment: 
      MYSQL_ROOT_PASSWORD: 'password'
      MYSQL_ROOT_HOST: '%'
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      timeout: 20s
      retries: 10
    ports:
      - "3303:3306"
    # Comment the following two lines for ephemeral mode. The data
    # will henceforth reside only in the container for its lifetime.
    # Once the container is deleted, the data will also be deleted.
    # See README.md for persistant data recover is a container is 
    # lost/deleted.
    volumes: 
      - ./data/server-3:/var/lib/mysql      
    restart: always
    command: [
      "mysqld",
      "--server_id=3",
      "--mysqlx=ON",
      "--binlog_checksum=NONE",
      "--gtid_mode=ON",
      "--enforce_gtid_consistency=ON",
      "--log_bin",
      "--log_slave_updates=ON",
      "--master_info_repository=TABLE",
      "--relay_log_info_repository=TABLE",
      "--transaction_write_set_extraction=XXHASH64",
      "--user=root",
      "--skip-host-cache",
      "--skip-name-resolve", 
      "--default_authentication_plugin=mysql_native_password",
      "--binlog_transaction_dependency_tracking=WRITESET"]

  mysql-router:
    image: mysql/mysql-router
    container_name: mysql-router
    environment:
      MYSQL_HOST: 'mysql-server-1'
      MYSQL_PORT: 3306
      MYSQL_USER: 'root'
      MYSQL_PASSWORD: 'password'
      MYSQL_INNODB_NUM_MEMBERS: 3
      MYSQL_CREATE_ROUTER_USER: 0
      # MYSQL_ROUTER_BOOTSTRAP_EXTRA_OPTIONS="--extra-config /etc/mysqlrouter-custom/mysqlrouter.conf --ssl-mode DISABLED --client-ssl-mode DISABLED"
      # MYSQL_ROUTER_BOOTSTRAP_EXTRA_OPTIONS="--force --extra-config /etc/mysqlrouter-custom/mysqlrouter.conf --client-ssl-mode PASSTHROUGH --server-ssl-ca /etc/mysqlrouter-custom/certificates/ca.pem --client-ssl-cert /etc/mysqlrouter-custom/certificates/server-cert.pem --client-ssl-key /etc/mysqlrouter-custom/certificates/server-key.pem"
    ports:
      - "8088:8088"
      - "6446:6446"
    volumes:
      - ./docker/mysql-router:/etc/mysqlrouter-custom
    depends_on:
      - mysql-server-1
      - mysql-server-2
      - mysql-server-3
      - mysql-shell
    restart: on-failure

  # Note: For interactive Mode, uncomment the entrypoint.
  #       This will allow for maintenance if your original
  #       containers are lost and the databases are being 
  #       persisted in data/server1..3. See README.md
  #
  #   Use:
  #     1. docker exec -it mysql-shell bash
  #     2. The container's /scripts/remove-metadata.sh
  #        - Removes the mysql_innodb_cluster_metadata schemas
  #          in each database (mysql-server1...3)
  #     3. Use this project's utils/bat/remove-cluster-config.bat
  #        - This removes the mysqld-auto.cnf files from each 
  #          persisted database. See data/server-1...3

  mysql-shell:
    image: norpac/mysql-shell
    container_name: mysql-shell
    # entrypoint: tail -f /dev/null
    environment:
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=password
      - MYSQL_HOST_1=mysql-server-1
      - MYSQL_HOST_2=mysql-server-2
      - MYSQL_HOST_3=mysql-server-3
      - MYSQL_PORT_1=3306
      - MYSQL_PORT_2=3306
      - MYSQL_PORT_3=3306
    volumes:
        - ./docker/scripts:/scripts
    depends_on:
      mysql-server-1:
        condition: service_healthy
      mysql-server-2:
        condition: service_healthy
      mysql-server-3:
        condition: service_healthy